<div class="front">
  <div class="english">{{English definition}}</div>

  <div class="smallEnglish">{{Grammar}}</div>

  <div class="typeInput">{{type:Expression}}</div>

  <!-- HIDDEN correct answer for live checking -->
  <div id="correct-answer" data-answer="{{Expression}}" style="display: none"></div>
  <script>
    function norm(s) {
      return (s || "").trim().replace(/\s+/g, " ").toLowerCase();
    }

    (function () {
      const input = document.getElementById("typeans");
      const correct = document.getElementById("correct-answer")?.dataset?.answer || "";
      const correctN = norm(correct);

      let autoFlipped = false;
      let composing = false;

      function setNeutral() {
        input.classList.remove("type-ok", "type-bad");
        const card = document.querySelector(".card");
        if (card) card.classList.remove("is-correct", "is-incorrect");
      }

      // Auto-submit (flip) when correct
      function flipNow() {
        if (autoFlipped) return;
        autoFlipped = true;
        setTimeout(() => {
          try {
            if (typeof pycmd === "function") {
              pycmd("ans");
            } else {
              const btn = document.getElementById("ansbut");
              if (btn) btn.click();
              else {
                document.dispatchEvent(new KeyboardEvent("keydown", { key: "Enter", keyCode: 13, which: 13, bubbles: true }));
              }
            }
          } catch (e) {
            console.error("Auto-flip failed:", e);
            autoFlipped = false;
          }
        }, 500);
      }

      function checkNow() {
        if (!input || composing) return;

        const userRaw = input.value;
        const userN = norm(userRaw);

        if (userN === "") {
          setNeutral();
          return;
        }

        const ok = userN === correctN;

        input.classList.toggle("type-ok", ok);
        input.classList.toggle("type-bad", !ok);

        const card = document.querySelector(".card");
        if (card) {
          card.classList.toggle("is-correct", ok);
          card.classList.toggle("is-incorrect", !ok);
        }

        if (ok) flipNow();
      }

      if (input) {
        // IME guards so user doesn't flip mid-composition
        // input.addEventListener("compositionstart", () => { composing = true; });
        // input.addEventListener("compositionend", () => { composing = false; checkNow(); });

        input.addEventListener("input", checkNow);
        input.addEventListener("change", checkNow);
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") checkNow();
        });

        setNeutral();
      }
    })();
  </script>
</div>